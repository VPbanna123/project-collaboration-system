// Project Service - Owns Project, Task, Comment, Document data
// Database: project_db (port: 5434)

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Project (Workspace) - PRIMARY DATA OWNER
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  teamId      String   // Reference to Team in team-service (no FK)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tasks     Task[]
  documents Document[]

  @@index([teamId])
  @@map("projects")
}

// Task - PRIMARY DATA OWNER
model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  projectId   String
  assignedTo  String?    // Reference to User in user-service (no FK)
  createdBy   String     // Reference to User in user-service (no FK)
  dueDate     DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  comments Comment[]

  @@index([projectId])
  @@index([assignedTo])
  @@index([createdBy])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Task comments - PRIMARY DATA OWNER
model Comment {
  id        String   @id @default(cuid())
  content   String
  taskId    String
  userId    String   // Reference to User in user-service (no FK)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@map("comments")
}

// Collaborative Document - PRIMARY DATA OWNER
model Document {
  id        String   @id @default(cuid())
  title     String
  content   String   @default("")
  projectId String
  createdBy String   // Reference to User in user-service (no FK)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  edits DocumentEdit[]
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("documents")
}

// Document edit history - PRIMARY DATA OWNER
model DocumentEdit {
  id         String     @id @default(cuid())
  documentId String
  userId     String     // Reference to User in user-service (no FK)
  userName   String     // Cached from user-service
  content    String
  startPos   Int
  endPos     Int
  action     EditAction
  createdAt  DateTime   @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@map("document_edits")
}

enum EditAction {
  INSERT
  DELETE
  REPLACE
}

// Denormalized user data for faster queries (synced from user-service)
model UserSnapshot {
  id        String   @id
  userId    String   @unique
  email     String
  name      String?
  imageUrl  String?
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("user_snapshots")
}